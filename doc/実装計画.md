## プロジェクト概要

| 項目 | 内容 |
|------|------|
| プロジェクト名 | dynamodb-shop |
| ディレクトリ | `~/dynamodb-shop` |
| 目的 | DynamoDBの主要機能を学習 |
| バックエンド | Go |
| フロントエンド | Vue.js |
| データベース | AWS DynamoDB |

---

## プロジェクト構成

```
~/dynamodb-shop/
├── backend/
│   ├── cmd/api/main.go           # エントリーポイント
│   ├── internal/
│   │   ├── config/               # 設定管理
│   │   ├── domain/               # エンティティ定義
│   │   ├── repository/           # DynamoDB操作
│   │   ├── service/              # ビジネスロジック
│   │   ├── handler/              # APIハンドラー
│   │   └── middleware/           # 認証・CORS
│   ├── go.mod
│   └── .env
│
├── frontend/
│   ├── src/
│   │   ├── views/                # 画面
│   │   ├── components/           # コンポーネント
│   │   ├── store/                # Pinia状態管理
│   │   ├── api/                  # APIクライアント
│   │   └── router/
│   ├── package.json
│   └── vite.config.js
│
├── lambda/
│   └── inventory-stream-handler/ # Streams処理
│
├── infrastructure/
│   └── scripts/
│       ├── create-table.sh       # テーブル作成
│       ├── seed-data.sh          # 初期データ
│       └── setup-lambda.sh       # Lambda設定
│
└── docker-compose.yml            # ローカル開発用
```

---

## DynamoDBテーブル設計

### テーブル名: `DynamoDBShop`

```
Billing Mode: PAY_PER_REQUEST (オンデマンド)
Streams: 有効 (NEW_AND_OLD_IMAGES)
TTL: 有効 (TTL属性)
```

### キー設計（Single Table Design）

| エンティティ | PK | SK |
|------------|----|----|
| ユーザー | `USER#<userId>` | `PROFILE` |
| 商品 | `PRODUCT#<productId>` | `METADATA` |
| カート | `USER#<userId>` | `CART#<productId>` |
| 注文 | `USER#<userId>` | `ORDER#<orderId>` |
| 注文明細 | `ORDER#<orderId>` | `ITEM#<productId>` |
| 価格履歴 | `PRODUCT#<productId>` | `PRICE#<timestamp>` |
| 在庫ログ | `PRODUCT#<productId>` | `INVLOG#<timestamp>` |
| 行動ログ | `USER#<userId>` | `ACTIVITY#<timestamp>` |

### GSI設計

| GSI | PK | SK | 用途 |
|-----|----|----|------|
| GSI1 | `CATEGORY#<cat>` | `PRODUCT#<id>` | カテゴリ別商品 |
| GSI1 | `EMAIL#<email>` | `USER` | メール検索 |
| GSI1 | `ORDERS#<yyyy-mm>` | `<timestamp>#<id>` | 月別注文 |

詳細: [[DynamoDB - Single Table Design]]

---

## API設計

### 認証

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| POST | `/api/v1/auth/register` | 会員登録 |
| POST | `/api/v1/auth/login` | ログイン（JWT発行） |
| GET | `/api/v1/auth/me` | 現在のユーザー |

### 商品

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| GET | `/api/v1/products` | 一覧（?category=でフィルタ） |
| GET | `/api/v1/products/:id` | 詳細 |
| GET | `/api/v1/products/:id/price-history` | 価格履歴 |
| POST | `/api/v1/products` | 登録（管理者） |
| PUT | `/api/v1/products/:id` | 更新（楽観的ロック） |
| PUT | `/api/v1/products/:id/price` | 価格更新 |
| PUT | `/api/v1/products/:id/stock` | 在庫調整 |

### カート

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| GET | `/api/v1/cart` | 取得 |
| POST | `/api/v1/cart/items` | 追加 |
| PUT | `/api/v1/cart/items/:productId` | 数量更新 |
| DELETE | `/api/v1/cart/items/:productId` | 削除 |

### 注文

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| POST | `/api/v1/orders` | 確定（トランザクション） |
| GET | `/api/v1/orders` | 履歴一覧 |
| GET | `/api/v1/orders/:id` | 詳細 |

### 分析・ログ

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| POST | `/api/v1/activity` | 行動ログ記録 |
| GET | `/api/v1/admin/inventory-logs` | 在庫変動履歴 |

---

## 画面設計

### 公開ページ

| パス | 画面 | 機能 |
|------|------|------|
| `/` | トップ | おすすめ商品 |
| `/products` | 商品一覧 | カテゴリフィルタ |
| `/products/:id` | 商品詳細 | 価格履歴グラフ |
| `/cart` | カート | 数量変更、削除 |
| `/checkout` | 注文確認 | 注文確定 |
| `/login` | ログイン | |
| `/register` | 会員登録 | |

### 会員ページ

| パス | 画面 |
|------|------|
| `/orders` | 注文履歴 |
| `/orders/:id` | 注文詳細 |

### 管理者ページ

| パス | 画面 |
|------|------|
| `/admin` | ダッシュボード |
| `/admin/products` | 商品管理 |
| `/admin/inventory` | 在庫・変動履歴 |
| `/admin/analytics` | ユーザー行動分析 |

---

## 実装フェーズ

### Phase 1: 基盤構築

**学習目標**: [[DynamoDB - 基本操作 (CRUD)]], [[DynamoDB - Single Table Design]], [[DynamoDB - GSI (グローバルセカンダリインデックス)]]

#### 完了済み

- [x] プロジェクトディレクトリ作成
- [x] Go モジュール初期化
- [x] Vue.js プロジェクト作成（TypeScript）
- [x] DynamoDB クライアント実装 (`repository/dynamodb.go`)
- [x] ドメインモデル定義
  - [x] `domain/user.go` - User, RegisterRequest, LoginRequest
  - [x] `domain/product.go` - Product, CreateProductRequest, UpdateProductRequest
- [x] ユーザーリポジトリ (`repository/user_repo.go`)
  - [x] PutItem でユーザー作成
  - [x] GetItem でユーザー取得
  - [x] GSI Query でメール検索
- [x] ミドルウェア・ハンドラー（Claude Code担当）
  - [x] JWT認証ミドルウェア (`middleware/auth.go`)
  - [x] 認証ハンドラー (`handler/auth_handler.go`)
  - [x] 商品ハンドラー (`handler/product_handler.go`)
  - [x] ルーター設定 (`handler/router.go`)
- [x] フロントエンド（Claude Code担当）
  - [x] 商品一覧・詳細画面
  - [x] ログイン・会員登録画面
  - [x] Pinia ストア、APIクライアント

#### 残りの作業

- [x] 商品リポジトリ (`repository/product_repo.go`)
  - [x] PutItem で商品登録
  - [x] GetItem で商品詳細
  - [x] GSI Query で全商品一覧
  - [x] GSI Query でカテゴリ検索（begins_with）
  - [x] UpdateItem で商品更新
  - [x] DeleteItem で商品削除
- [x] サービス層実装
  - [x] `service/user_service.go` - Register, Login, GetByID
  - [x] `service/product_service.go` - List, GetByID, Create, Update, Delete
- [x] main.go 依存関係接続
  - [x] DynamoDBClient 初期化
  - [x] Repository → Service → Handler の接続
- [x] DynamoDB テーブル作成（AWS CLI）
  - [x] `infrastructure/scripts/create-table.sh` 実行
- [x] 動作確認
  - [x] ユーザー登録 API テスト
  - [x] ログイン API テスト
  - [x] 商品 CRUD API テスト
  - [x] フロントエンドとの結合テスト（オプション）

**主要ファイル**:
- `backend/internal/domain/user.go` ✅
- `backend/internal/domain/product.go` ✅
- `backend/internal/repository/dynamodb.go` ✅
- `backend/internal/repository/user_repo.go` ✅
- `backend/internal/repository/product_repo.go` ✅
- `backend/internal/service/user_service.go`✅
- `backend/internal/service/product_service.go`✅
- `backend/cmd/api/main.go`✅
- `infrastructure/scripts/create-table.sh` ✅

---

### Phase 2: カート・条件付き書き込み

**学習目標**: [[DynamoDB - 条件付き書き込みと楽観的ロック]]

#### 完了済み

- [x] ドメインモデル更新 (`domain/cart.go`)
  - [x] Version 属性追加（楽観的ロック用）
  - [x] UpdatedAt 属性追加
  - [x] UpdateCartRequest に Version 追加
- [x] カートリポジトリ (`repository/cart_repo.go`)
  - [x] PutItem でカート追加 (`Add`)
  - [x] UpdateItem で数量更新 (`UpdateQuantity`) - 楽観的ロック付き
  - [x] DeleteItem でカート削除 (`Delete`)
  - [x] Query でカート全取得 (`GetByUserID`) - begins_with使用
  - [x] GetItem でカートアイテム1件取得 (`GetItem`)
  - [x] BatchWriteItem でカート全削除 (`Clear`)
- [x] 楽観的ロック実装（リポジトリ層）
  - [x] Version 属性追加
  - [x] ConditionExpression でバージョンチェック
  - [x] ConditionalCheckFailedException → ErrVersionMismatch

- [x] カートサービス (`service/cart_service.go`)
  - [x] GetCart - カート取得（合計金額計算）
  - [x] AddItem - カート追加（在庫チェック付き）
  - [x] UpdateQuantity - 数量更新（リトライロジック）
  - [x] RemoveItem - カート削除
  - [x] ClearCart - カート全削除

- [x] ハンドラー・ルーター（Claude Code担当）
  - [x] カートハンドラー (`handler/cart_handler.go`)
  - [x] ルーター設定更新 (`handler/router.go`)
  - [x] main.go 依存関係接続

#### 残りの作業

- [ ] フロントエンド：カート画面（Claude Code担当）
- [ ] 動作確認
  - [ ] カート追加 API テスト
  - [ ] カート取得 API テスト
  - [ ] 数量更新 API テスト（楽観的ロック）
  - [ ] カート削除 API テスト

**主要ファイル**:
- `backend/internal/domain/cart.go` ✅
- `backend/internal/repository/cart_repo.go` ✅
- `backend/internal/service/cart_service.go` ✅
- `backend/internal/handler/cart_handler.go` ✅
- `backend/internal/handler/router.go` ✅
- `backend/cmd/api/main.go` ✅

---

### Phase 3: 注文・トランザクション

**学習目標**: [[DynamoDB - トランザクション]]

- [ ] 注文確定トランザクション実装
  - [ ] 注文ヘッダー作成
  - [ ] 注文明細作成
  - [ ] 在庫減算（条件付き）
  - [ ] カートクリア
  - [ ] 全操作を TransactWriteItems で実行
- [ ] トランザクションエラーハンドリング
  - [ ] ConditionalCheckFailed（在庫不足）
  - [ ] TransactionConflict（競合）
- [ ] 注文履歴機能
  - [ ] Query でユーザーの注文一覧
  - [ ] Query で注文明細取得
- [ ] フロントエンド：注文確認・履歴画面

**主要ファイル**:
- `backend/internal/service/order_service.go` ★最重要
- `backend/internal/repository/order_repo.go`

---

### Phase 4: 時系列データ・範囲クエリ

**学習目標**: [[DynamoDB - 時系列データモデリング]]

- [ ] 価格履歴機能
  - [ ] 価格更新時に履歴レコード作成
  - [ ] SK=`PRICE#<timestamp>` で時系列保存
  - [ ] BETWEEN クエリで範囲取得
- [ ] 在庫変動ログ
  - [ ] 在庫変更時に履歴レコード作成
  - [ ] SK=`INVLOG#<timestamp>` で時系列保存
- [ ] ページネーション実装
  - [ ] Limit + LastEvaluatedKey
- [ ] フロントエンド：価格履歴グラフ（Chart.js）
- [ ] 管理画面：在庫変動履歴

**主要ファイル**:
- `backend/internal/repository/price_history_repo.go`
- `backend/internal/repository/inventory_repo.go`
- `frontend/src/components/product/PriceHistoryChart.vue`

---

### Phase 5: TTL・高スループット書き込み

**学習目標**: [[DynamoDB - TTL (Time To Live)]]

- [ ] ユーザー行動ログ実装
  - [ ] TTL 属性付きでログ記録（30日後自動削除）
  - [ ] ActionType: VIEW, CLICK, ADD_CART, PURCHASE
- [ ] BatchWriteItem で一括書き込み
  - [ ] 25件ずつバッチ処理
- [ ] フロントエンドからのログ送信
  - [ ] 商品閲覧時
  - [ ] クリック時
  - [ ] デバウンス処理
- [ ] 管理画面：ユーザー行動分析

**主要ファイル**:
- `backend/internal/repository/activity_repo.go`
- `frontend/src/views/admin/UserActivity.vue`

---

### Phase 6: DynamoDB Streams + Lambda

**学習目標**: [[DynamoDB - Streams と Lambda]]

- [ ] Lambda 関数作成（Go）
  - [ ] DynamoDB Streams イベント処理
  - [ ] 在庫変動の検知
  - [ ] 閾値以下で LOW STOCK ALERT
- [ ] Streams トリガー設定
  - [ ] イベントソースマッピング
- [ ] Lambda デプロイ
  - [ ] IAM ロール作成
  - [ ] 関数作成
- [ ] 動作確認
  - [ ] 商品の在庫を減らしてアラート発生確認

**主要ファイル**:
- `lambda/inventory-stream-handler/main.go`
- `infrastructure/scripts/setup-lambda.sh`

---

## 環境変数

### backend/.env

```bash
AWS_REGION=ap-northeast-1
AWS_ACCESS_KEY_ID=your-access-key
AWS_SECRET_ACCESS_KEY=your-secret-key
DYNAMODB_TABLE=DynamoDBShop
# DYNAMODB_ENDPOINT=http://localhost:8000  # ローカル開発時

JWT_SECRET=your-jwt-secret-key
JWT_EXPIRY=24h

SERVER_PORT=8080
```

### frontend/.env

```bash
VITE_API_URL=http://localhost:8080/api/v1
```

---

## AWSリソース

| サービス | リソース名 | 用途 |
|---------|-----------|------|
| DynamoDB | DynamoDBShop | メインテーブル |
| Lambda | inventory-stream-handler | 在庫変動処理 |
| IAM | dynamodb-shop-app-user | アプリ用認証 |
| IAM | dynamodb-shop-lambda-role | Lambda実行ロール |

---

## コマンドリファレンス

### テーブル作成

```bash
aws dynamodb create-table \
    --table-name DynamoDBShop \
    --attribute-definitions \
        AttributeName=PK,AttributeType=S \
        AttributeName=SK,AttributeType=S \
        AttributeName=GSI1PK,AttributeType=S \
        AttributeName=GSI1SK,AttributeType=S \
    --key-schema \
        AttributeName=PK,KeyType=HASH \
        AttributeName=SK,KeyType=RANGE \
    --global-secondary-indexes '[
        {
            "IndexName": "GSI1",
            "KeySchema": [
                {"AttributeName": "GSI1PK", "KeyType": "HASH"},
                {"AttributeName": "GSI1SK", "KeyType": "RANGE"}
            ],
            "Projection": {"ProjectionType": "ALL"}
        }
    ]' \
    --billing-mode PAY_PER_REQUEST \
    --stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```

### TTL有効化

```bash
aws dynamodb update-time-to-live \
    --table-name DynamoDBShop \
    --time-to-live-specification "Enabled=true,AttributeName=TTL"
```

### テーブル確認

```bash
aws dynamodb describe-table --table-name DynamoDBShop
```

### データ確認

```bash
aws dynamodb scan --table-name DynamoDBShop --limit 10
```

---

## 進捗メモ

### Phase 1

```
開始日: 2025-01-23
完了日: 2025-01-30
メモ:
- domain/user.go, domain/product.go 完了
- repository/dynamodb.go, user_repo.go, product_repo.go 完了
- service/user_service.go, product_service.go 完了
- main.go依存関係接続完了
- DynamoDBテーブル作成（AWS）完了
- API動作確認完了（登録、ログイン、商品CRUD）
```

### Phase 2

```
開始日: 2025-01-30
完了日:
メモ:
- domain/cart.go に Version, UpdatedAt 属性追加（楽観的ロック用）
- cart_repo.go 実装完了
  - Add: PutItem でカート追加
  - GetByUserID: Query + begins_with でユーザーのカート全取得
  - GetItem: GetItem でカートアイテム1件取得
  - UpdateQuantity: UpdateItem + ConditionExpression で楽観的ロック
  - Delete: DeleteItem でカート削除
  - Clear: BatchWriteItem でカート全削除
- cart_service.go 実装完了
  - GetCart: カート取得 + 合計金額計算
  - AddItem: 在庫チェック + 既存アイテム数量加算
  - UpdateQuantity: 楽観的ロック + リトライロジック（最大3回）
  - RemoveItem / ClearCart: カート削除
- cart_handler.go 実装完了（Claude Code担当）
  - GET /api/v1/cart - カート取得
  - POST /api/v1/cart/items - カート追加
  - PUT /api/v1/cart/items/{productId} - 数量更新
  - DELETE /api/v1/cart/items/{productId} - カート削除
- router.go, main.go 更新完了
- 楽観的ロックの学習ポイント:
  - ConditionExpression: "version = :currentVer"
  - ConditionalCheckFailedException で競合検知
  - リトライ: 最新バージョン取得 → 再試行
```

### Phase 3

```
開始日:
完了日:
メモ:
```

### Phase 4

```
開始日:
完了日:
メモ:
```

### Phase 5

```
開始日:
完了日:
メモ:
```

### Phase 6

```
開始日:
完了日:
メモ:
```
